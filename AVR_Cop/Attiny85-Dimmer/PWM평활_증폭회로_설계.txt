================================================================================
  STM32 PWM → ATtiny85 ADC 신호 변환 회로 설계
  PWM 주파수: 3kHz, 듀티비 가변 (0~100%)
  출력: 0~3.3V → 증폭 → 0~5V
================================================================================

┌──────────────────────────────────────────────────────────────────────────┐
│ 1. RC 평활 회로 (PWM → DC 변환)                                          │
└──────────────────────────────────────────────────────────────────────────┘

PWM 주파수: 3kHz (주기 T = 333μs)
시정수 선택: τ = RC = 10T = 3.33ms (리플 <1% 목표)

         STM32 PWM
         (3kHz, 0~3.3V)
              │
              ├─────┐
              │     │
             R1    C1
            4.7kΩ  1μF
              │     │
              ├─────┤
              │     │
             GND   GND
              │
              └──── DC 출력 (0~3.3V) ──→ OP-AMP로

**계산:**
τ = R1 × C1 = 4.7kΩ × 1μF = 4.7ms = 14.1T  ✓

**리플 전압:**
Vripple = Vout × (1/(2×f×R×C))
        = 3.3V × (1/(2×3000×4700×0.000001))
        = 3.3V × 0.0354
        = 117mV (3.5% 리플) → 실용적 수준


┌──────────────────────────────────────────────────────────────────────────┐
│ 2. LM358 비반전 증폭기 회로                                               │
└──────────────────────────────────────────────────────────────────────────┘

                          +5V (ATtiny85 VCC)
                           │
                      ┌────┴────┐
                  R6  │         │
                 100Ω │  LM358  │ Pin 8 (VCC)
              ┌───────┤         │
              │       │  Op-Amp │
              │   ┌───┤ Pin 3(+)│
              │   │   │         │
   RC평활 ────┼───┤   │ Pin 2(-)├────┐
   출력       │   │   │         │    │
   (0~3.3V)   │   R3  │ Pin 1   ├────┤
              │  10kΩ │ (OUT)   │    │
              │   │   │         │    │
              │  GND  └────┬────┘    │
              │            │         │
             C2           GND        │
            0.1μF        Pin 4       │
              │                      │
             GND                     │
                                     │
              ┌──────────────────────┘
              │
              ├─── R4 (10kΩ 고정)
              │
              ├─── VR1 (10kΩ 트리머)
              │
             GND
              │
              └──────────────────── 출력 → ATtiny85 ADC (PB3)
                                     │
                                    C3 (0.1μF)
                                     │
                                    GND

**증폭률 계산:**
Gain = 1 + (R4 + VR1) / R3
     = 1 + (10kΩ + 0~10kΩ) / 10kΩ
     = 1.0 ~ 3.0 배 (가변)

**조정 방법:**
1. STM32에서 100% PWM 출력 (3.3V DC)
2. VR1을 돌려서 ATtiny85 ADC 입력이 5V가 되도록 조정
   (멀티미터로 측정하거나 ADC 값이 1023이 되도록)
3. 전압 강하 발생 시 (예: 2.8V) VR1로 보상 가능


┌──────────────────────────────────────────────────────────────────────────┐
│ 3. 완전한 회로도 (ASCII)                                                  │
└──────────────────────────────────────────────────────────────────────────┘

STM32                RC 평활회로              LM358 증폭기           ATtiny85
PWM Out  ───────┬─────────────────┬──────────────────────────┬──── PB3(ADC3)
(3kHz)   │      │                 │                          │
         │     R1                C1                         C3
         │    4.7kΩ              1μF                       0.1μF
         │      │                 │                          │
         │     GND               GND                        GND
         │      │                 │
         │      └─────────────────┴─── DC (0~3.3V)
         │                        │
         │                    ┌───┼─── R6 (100Ω) ─── +5V
         │                    │   │
         │                   C2   │                    +5V
         │                  0.1μF │                     │
         │                    │   │               ┌─────┴─────┐
         │                   GND  │               │   LM358   │
         │                        │           R3  │           │
         │                        └───────── 10kΩ─┤ Pin 3 (+) │
         │                                    │   │           │
         │                                   GND  │ Pin 2 (-) ├─┐
         │                                        │           │ │
         │                                        │ Pin 1(OUT)├─┤
         │                                        │           │ │
         │                                        └─────┬─────┘ │
         │                                              │       │
         │                                             GND      │
         │                                            Pin 4     │
         │                                                      │
         │         ┌────────────────────────────────────────────┘
         │         │
         │         ├─── R4 (10kΩ 고정)
         │         │
         │         ├─── VR1 (10kΩ 트리머, 증폭률 조정)
         │         │
         │        GND
         │
         └────────────────────── ATtiny85 PB3 (Pin 2)


┌──────────────────────────────────────────────────────────────────────────┐
│ 4. BOM (Bill of Materials)                                               │
└──────────────────────────────────────────────────────────────────────────┘

NO  부품명              값/규격           수량  용도                    비고
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
[RC 평활 회로]
1   저항 R1            4.7kΩ, 1/4W       1     PWM 평활 시정수         ±5%
2   커패시터 C1        1μF, 50V          1     PWM 평활 필터           세라믹/필름
3   커패시터 C2        0.1μF, 50V        1     OP-AMP 입력 노이즈 제거 세라믹

[LM358 증폭 회로]
4   OP-AMP IC          LM358N (DIP-8)    1     비반전 증폭기           단일전원 5V
5   IC 소켓            DIP-8             1     LM358 장착용            (선택사항)
6   저항 R3            10kΩ, 1/4W        1     증폭 피드백 기준        ±1% 정밀
7   저항 R4            10kΩ, 1/4W        1     증폭 피드백 고정        ±1% 정밀
8   가변저항 VR1       10kΩ 트리머       1     증폭률 조정 (1~3배)     다회전 권장
9   저항 R6            100Ω, 1/4W        1     OP-AMP 입력 보호        ±5%

[출력 필터 및 보호]
10  커패시터 C3        0.1μF, 50V        1     ATtiny85 ADC 노이즈제거 세라믹

[전원]
11  +5V 전원           5V DC             1     ATtiny85 & LM358 공통   안정화 전원

[기타]
12  점퍼 와이어        -                 약간  연결용
13  브레드보드/PCB     -                 1     회로 조립용


┌──────────────────────────────────────────────────────────────────────────┐
│ 5. 부품 상세 설명                                                         │
└──────────────────────────────────────────────────────────────────────────┘

[LM358N 핀 배치]
        ┌───∪───┐
OUT1  1 │       │ 8  VCC (+5V)
IN1-  2 │ LM358 │ 7  OUT2
IN1+  3 │       │ 6  IN2-
GND   4 │       │ 5  IN2+
        └───────┘

사용 핀:
- Pin 1: 출력 (OUT1) → ATtiny85 ADC
- Pin 2: 반전 입력 (-) → 피드백 (R4+VR1)
- Pin 3: 비반전 입력 (+) → RC 평활 출력
- Pin 4: GND
- Pin 8: VCC (+5V)


[10kΩ 트리머 가변저항]
        ┌─────┐
    1 ──┤     ├── 3
        │ VR1 │
    2 ──┤     │ (와이퍼)
        └─────┘

연결:
- Pin 1: GND
- Pin 2 (와이퍼): OP-AMP Pin 2 (반전 입력)
- Pin 3: R4를 통해 OP-AMP Pin 1 (출력)


┌──────────────────────────────────────────────────────────────────────────┐
│ 6. 성능 사양                                                              │
└──────────────────────────────────────────────────────────────────────────┘

입력:
- PWM 주파수:        3kHz (고정)
- PWM 전압:          0 ~ 3.3V
- 듀티비:            0 ~ 100%

평활 후:
- DC 전압:           0 ~ 3.3V
- 리플 전압:         ~117mV (3.5%)
- 응답 시간:         ~15ms (3τ = 14.1ms)

증폭 후:
- 출력 전압:         0 ~ 5V (VR1 조정 시)
- 증폭률:            1.0 ~ 3.0배 (가변)
- 대역폭:            1MHz (LM358 GBW)
- 출력 임피던스:     ~75Ω

ATtiny85 ADC 입력:
- 전압 범위:         0 ~ 5V
- ADC 분해능:        10-bit (0 ~ 1023)
- 입력 임피던스:     100MΩ (high-Z)


┌──────────────────────────────────────────────────────────────────────────┐
│ 7. 조립 및 조정 절차                                                      │
└──────────────────────────────────────────────────────────────────────────┘

[1단계] RC 평활회로 조립
   1. R1(4.7kΩ)와 C1(1μF)를 STM32 PWM 출력에 연결
   2. 멀티미터로 평활 전압 확인 (50% 듀티 → 1.65V)

[2단계] LM358 증폭기 조립
   1. LM358 Pin 8에 +5V, Pin 4에 GND 연결
   2. Pin 3(+)에 RC 평활 출력 연결 (C2 0.1μF 통과)
   3. R3(10kΩ)를 Pin 3과 GND 사이 연결
   4. R4(10kΩ) + VR1(10kΩ)를 Pin 1(출력)과 Pin 2(-) 사이 연결
   5. VR1의 한쪽 끝을 GND에 연결

[3단계] 출력 연결
   1. LM358 Pin 1 출력에 C3(0.1μF) 필터 추가
   2. ATtiny85 PB3(Pin 2)에 연결

[4단계] 교정 (Calibration)
   1. STM32에서 100% PWM 출력 (3.3V DC)
   2. 멀티미터로 LM358 출력 전압 측정
   3. VR1을 돌려서 정확히 5.0V가 되도록 조정
   4. STM32에서 0% PWM 출력 → 0V 확인
   5. 50% PWM 출력 → 2.5V 확인 (선형성 검증)

[5단계] 최종 검증
   1. ATtiny85에서 ADC 값 읽기
   2. 0% PWM → ADC = 0
   3. 50% PWM → ADC = 512
   4. 100% PWM → ADC = 1023


┌──────────────────────────────────────────────────────────────────────────┐
│ 8. 문제 해결 (Troubleshooting)                                           │
└──────────────────────────────────────────────────────────────────────────┘

증상: 출력 전압이 5V를 초과
원인: VR1 증폭률이 너무 높음
해결: VR1을 반대 방향으로 돌려 증폭률 감소

증상: 출력 전압이 4.7V에서 멈춤
원인: LM358의 Rail-to-Rail 한계 (출력이 VCC-0.3V)
해결: 정상 동작, VR1을 약간 더 돌려서 보상

증상: 리플이 너무 큼 (>100mV)
원인: C1 용량 부족
해결: C1을 2.2μF 또는 4.7μF로 증가

증상: 응답이 느림 (>50ms)
원인: RC 시정수가 너무 큼
해결: R1을 2.2kΩ로 감소 (리플 증가 트레이드오프)

증상: 0% PWM에서도 전압이 0이 아님 (오프셋)
원인: OP-AMP 입력 오프셋 전압 (~2mV)
해결: 소프트웨어에서 ADC < 5 일 때 0으로 처리


┌──────────────────────────────────────────────────────────────────────────┐
│ 9. 대체 부품 (Alternative Parts)                                         │
└──────────────────────────────────────────────────────────────────────────┘

LM358 대체:
- LMV358: 레일-투-레일 출력 (5V까지 정확히 출력 가능)
- TL082: 고성능, 낮은 오프셋
- MCP602: CMOS, 저전력

커패시터 C1 대체:
- 필름 커패시터 (폴리프로필렌): 낮은 ESR, 정밀한 평활
- 세라믹 X7R: 온도 안정성 좋음
- 전해 커패시터 (10μF): 더 낮은 리플 (응답 느림)


┌──────────────────────────────────────────────────────────────────────────┐
│ 10. PCB 레이아웃 팁                                                       │
└──────────────────────────────────────────────────────────────────────────┘

1. RC 평활 회로를 STM32 출력 근처에 배치
2. LM358 VCC 핀 근처에 0.1μF 바이패스 캐패시터 추가
3. GND는 스타 그라운드 또는 그라운드 플레인 사용
4. VR1은 PCB 엣지에 배치하여 조정 용이하게
5. ATtiny85 ADC 입력 라인은 짧고 직선으로 배선
6. 신호 라인과 전원 라인 분리 (노이즈 최소화)


================================================================================
설계 완료: 2025.11.09
작성자: GitHub Copilot
프로젝트: ATtiny85 AC Dimmer with STM32 PWM Control
================================================================================
